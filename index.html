<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Calendarium - smart life calendar with data skins</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BPS2S5MCLH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BPS2S5MCLH');
    </script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Smart Life Calendar with data skins from WHO and HMD">
    <meta name="keywords" content="Life Calendar, calendar">
    <meta name="author" content="Aleksei Sotskov">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"-->

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">

    <style type="text/css">
      @font-face {
        font-family: 'Verdana';
        src: URL('src/fonts/verdana/verdana.ttf') format('truetype');
      }
      @font-face {
        font-family: 'Verdana';
        src: URL('src/fonts/verdana/verdana-bold.ttf') format('truetype');
        font-weight: bold;
      }

      body, html {
        padding: 0;
        margin: 0;
        background-color: snow;
        font-family: 'Open Sans', sans-serif;
      }
      /* https://stackoverflow.com/questions/29205294/how-to-achieve-blinking-effect-in-svg */
      @keyframes blink {
        100%, 0% { fill: snow; }
        80% { fill: skyblue; stroke-width: 0.2; }
      }
      .blink {
        animation: blink 1.5s infinite;
      }
      .right {
        text-align: right;
        width: 50%;
        padding-left: 10px;
      }
      .left {
        text-align: left;
        padding-right: 10px;
      }
      /*
      #faq {
        //width: 600px;
        //margin-left: calc(50% - 300px);
        margin: 10% 0 10% 0;
      }
      #faq h1 {
        text-align: center;
        font-size: 1.5em;
      }*/
      p, ul, ol {
        font-size: 0.875rem;
      }
      ul {
        padding-left: 1.5em;
      }
      p.has_list {
        margin-bottom: 0.5rem;
      }
      #loading {
        left: 50%;
        top: 50%;
        position: absolute;
        transform: translate(-50%, -50%);
      }
      .form-floating>label {
        color: gray;
        padding: 0.75rem;
      }
      #calendar {
        margin: 10px;
      }
      @media only screen and (min-width: 992px) {
        #calendar {
          float: right;
        }
      }
      .container {
        padding: 0;
        margin-bottom: 10%;
      }
      .row {
        margin-left: 0;
        margin-right: 0;
      }
      input::-webkit-date-and-time-value {
        text-align: left;
      }
      .clarify_field {
        color: gray;
        padding-left: 3px;
      }
      input[type="date"]::-webkit-inner-spin-button,
      input[type="date"]::-webkit-calendar-picker-indicator {
        margin-top: -16px;
      }
      .controls_wrapper {
        margin-bottom: 7px;
      }
      #data_skin {
        background-color: bisque-;
        background-color: gainsboro-;
        background-color: khaki-;
        background-color: linen-;
        background-color: moccasin;
      }
      .xl_country_code {
        height: calc(4.6rem + calc(var(--bs-border-width) * 2)) !important;
        padding: 0.725rem !important;
        padding-top: 2.8rem !important;
      }
      select, button, a {
        cursor: pointer;
      }
      input {
        cursor: text;
      }
      .btn-light {
        border: 1px solid lightgray;
      }
      select, input {
        outline: none !important;
        box-shadow: none !important;
        -webkit-box-shadow: none !important;
      }
    </style>

    <!-- https://github.com/davidshimjs/qrcodejs -->
    <script type="text/javascript" src="src/js/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="src/js/qrcode/qrcode.min.js"></script>

    <script src="src/js/calendarium/dicts.js"></script>
    <script type="text/javascript">
      window.mobileCheck = function() {  // https://stackoverflow.com/questions/11381673/detecting-a-mobile-browser
        let check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
      };
      function is_iOS() {
        return [
          'iPad Simulator',
          'iPhone Simulator',
          'iPad',
          'iPhone',
        ].includes(navigator.platform)
      }
      function is_bad_mobile() {
        if (!is_iOS())
          return false;

        const iOS_version = /(iPhone|iPad) OS ([1-9]+)/g.exec(window.navigator.userAgent)?.[2] || 0; // https://gist.github.com/ngoclt/2857281
        return iOS_version <= 15; // for iOS 15 svg offset incorrectly calculated
      }
      const bad_mobile = is_bad_mobile();//is_iOS();//window.mobileCheck();
      const is_mobile = window.mobileCheck();

      const circle_radius = 2;
      const number_of_weeks_in_a_row = 52;
      let number_of_years = 101;
      const calendar_step_horizontal = 5;
      const calendar_step_vertical = 5;
      const calendar_weeks_numbers_height = 5;
      const calendar_years_numbers_width = 12;
      const calendar_le_at_birth_median_peak_width = 12;
      const calendar_new_year_label_height = 5;
      const calendar_qrcode_url_domain = "https://calendarium.me";
      const calendar_id = Math.random().toString(36).slice(2);  // https://stackoverflow.com/questions/10726909/random-alpha-numeric-string-in-javascript
      const svg_margin = 5;
      var qrcode;
      var antistroke = "black";
      var antistroke_width = 1;
      var stroke_width = 0.5;
      const color_base = "snow";
      const years = [1, 2, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90,];
      const available_controls = ['sex', 'birthday', 'country_code', 'country_code_latest', 'sex_to_compare'];
      const data_skin_default = 'all'; // 'mbly';
      const url_params_items = ['birthday', 'country_code', 'country_code_latest', 'sex', 'sex_to_compare', 'data_skin'];
      const available_sexes = ['m', 'f'];
      const sex_default = available_sexes[0];
      const percentiles_to_draw = [50, 80, 90];

      var who_stacked_coordinates;

      var data_fetched = {'dx': {}, 'mx': {}};
      var data_dx = {};
      var data_mx = {};
      var data_all = {'dx': [], 'mx': []};
      var last_year_in_dataset = 0;
      var last_year_in_dataset_1 = 0;
      var last_year_in_dataset_2 = 0;
      var number_of_mortality_charts_drawn = 0;
      var labels_percentiles = [{}, {}, {}];

      let calendar_top_offset = calendar_weeks_numbers_height + calendar_new_year_label_height + 5;
      let calendar_width_offset = calendar_years_numbers_width + calendar_le_at_birth_median_peak_width + 6 + 10 + 16;

      function get_year_from_date(date) {
        return new Date(date).getFullYear();
      }

      function get_calendar_height() {
        return number_of_years * calendar_step_vertical + calendar_top_offset;
      }
      function get_calendar_width() {
        return number_of_weeks_in_a_row * calendar_step_horizontal + calendar_width_offset;
      }

      function enrich_data_mdx_dict(data_mdx, mdx_data, country_code, sex, target_year) {
        const data_country = data_mdx[country_code];
        if (!data_country)
          data_mdx[country_code] = {};
        
        const data_country_sex = data_mdx[country_code][sex];
        if (!data_country_sex)
          data_mdx[country_code][sex] = {};

        const data_country_sex_year = data_mdx[country_code][sex][target_year];
        if (!data_country_sex_year)
          data_mdx[country_code][sex][target_year] = mdx_data;
      }

      /*
      function enrich_data_fetched_dict(country_code, sex, target_year) {
        const data_country = data_fetched['dx'][country_code];
        if (!data_country) {
          data_fetched['dx'][country_code] = {};
          data_fetched['mx'][country_code] = {};
        }
        
        const data_country_sex = data_fetched['dx'][country_code][sex];
        if (!data_country_sex) {
          data_fetched['dx'][country_code][sex] = {};
          data_fetched['mx'][country_code][sex] = {};
        }

        const data_country_sex_year = data_fetched['dx'][country_code][sex][target_year];
        if (!data_country_sex_year) {
          data_fetched['dx'][country_code][sex][target_year] = data_dx[country_code][sex][target_year];
          data_fetched['mx'][country_code][sex][target_year] = data_mx[country_code][sex][target_year];
        }
      }
      */

      function get_mortality_data(country_code, sex, target_year) {
        //if (data_fetched['dx'][country_code])
        //  if (data_fetched['dx'][country_code][sex])
        //    ;

        return fetch('https://calendarium.me/data/mortality/' + country_code + '/' + sex + 'ltper_1x1.txt')
          .then((response) => response.text())
          .then((data) => {
            const lines = data.split("\n");

            const offset_data_headers = 3;
            const index_column_year = 1;
            const index_column_mx = 3;
            const index_column_dx = 7;

            last_year_in_dataset = lines[lines.length - 2].split(' ')[2];
            if (!target_year)
              target_year = last_year_in_dataset;

            let mx_data = [];
            let dx_data = [];
            for (let i = offset_data_headers; i < lines.length; i++) {
              const splitted_data_line = lines[i].replace(/\s+/g, ',').split(',');
              const data_year = splitted_data_line[index_column_year];

              if (data_year == target_year) {
                dx_data.push(parseInt(splitted_data_line[index_column_dx]));
                mx_data.push(splitted_data_line[index_column_mx] * 100);
              }
            }

            data_all['mx'] = data_all['mx'].concat(mx_data.map(Number));
            enrich_data_mdx_dict(data_mx, mx_data, country_code, sex, target_year);
            data_all['dx'] = data_all['dx'].concat(dx_data.map(Number));
            enrich_data_mdx_dict(data_dx, dx_data, country_code, sex, target_year);

            //enrich_data_fetched_dict(country_code, sex, target_year);
          }
        );
      }

      function get_total(range) {
        return range.reduce((a, b) => a + b, 0);
      }

      function get_age(birthday_date) {  // returns number of full years from birthday till now
        const ms = new Date() - birthday_date;
        return Math.floor(ms / (1000 * 60 * 60 * 24 * 365.242199));
      }

      function get_percentiles(range, percentiles_range) {
        let percentiles = {};
        for (let i in percentiles_range) {
          percentiles[percentiles_range[i]] = 0;
        }

        const total = get_total(range);
        let integral = 0;        
        for (let i = 0; i < range.length; i++) {
          for (let j in percentiles_range) {
            if (integral <= percentiles_range[j] / 100) {
              percentiles[percentiles_range[j]] = i + 1;
            }
          }
          integral += range[i] / total;
        }
        return percentiles;
      }

      function get_peak_value(range) {
        const max_value = Math.max(...range);
        const peak = range.indexOf(max_value) + 1;  // to start from 1
        return {'peak': peak, 'value': max_value};
      }

      function generate_url(user_values) {
        return `${calendar_qrcode_url_domain}?p=${user_values.birthday},${user_values.country_code},${user_values.country_code_latest},${user_values.sex},${user_values.sex_to_compare},${user_values.data_skin}`;
      }
      function generate_qrcode_url(user_values) {
        //return generate_url(user_values) + `&cid=${calendar_id}&a=abc&b=cde&c=def`;
        return generate_url(user_values) + `&cid=${calendar_id}`;
      }

      function init_qrcode(user_values, size) {
        var qrcode = new QRCode(document.getElementById("qrcode"), {
          text: generate_qrcode_url(user_values),
          width: size,
          height: size,
          colorDark : "black",
          colorLight : "white",
          correctLevel : QRCode.CorrectLevel.L,  // L, M, Q, H
        });
        return qrcode;
      }

      function get_user_selected_parameters() {
        let result = {};
        url_params_items.forEach((item) => {
          result[item] = document.getElementById(item).value;
        });
        return result;
      }

      function set_user_selected_parameters(user_values) {
        url_params_items.forEach((item) => {
          if (!user_values[item])
            return;
          document.getElementById(item).value = user_values[item];
        });
      }

      function update_qrcode_url(user_values) {
        qrcode.clear();
        qrcode.makeCode(generate_qrcode_url(user_values));
      }

      function redraw_calendar() {
        const user_values = get_user_selected_parameters();
        if (window.location.protocol != 'file:') {  // doesn't work for local files
          window.history.replaceState(null, null, generate_url(user_values));
        }
        
        init_calendar(user_values);
        update_qrcode_url(user_values);
      }

      function change_country_of_birth() {
        const country_code = document.getElementById('country_code').value;
        document.getElementById('country_code_latest').value = country_code;
        redraw_calendar();
      }

      function change_sex() {
        const sex = document.getElementById('sex').value;
        document.getElementById('sex_to_compare').value = sex;
        redraw_calendar();
      }

      function calculate_weeks_between(earlier_date, later_date) {  // https://stackoverflow.com/questions/542938/how-to-calculate-number-of-days-between-two-dates
        const diff_ms = later_date - earlier_date;
        const diff_days = diff_ms / (1000 * 60 * 60 * 24);
        return Math.floor(diff_days / 7.024038461538462);  // (365*3+366)/4/52
      }

      function calculate_new_year_week(birthday_date) {
        const next_year = birthday_date.getFullYear() + 1;
        const diff_ms = new Date(next_year + '-01-01') - birthday_date;
        const diff_days = diff_ms / (1000 * 60 * 60 * 24);

        let week_new_year = Math.floor(diff_days / 7) + 1;  // no errors for weeks during 1 year
        if (week_new_year == 53)  // leap year week possible mistake fix
          week_new_year = 1;
        return week_new_year;
      }

      function draw_label_new_year(user_values) {
        const date = user_values['birthday'];
        const birthday_date = new Date(date);
        const week_new_year = calculate_new_year_week(birthday_date);
        const cx = week_new_year * calendar_step_horizontal + calendar_years_numbers_width + circle_radius + 1;
        let cy = get_calendar_height() - number_of_years * calendar_step_vertical - calendar_weeks_numbers_height - 1;
        if (bad_mobile)
          cy += 1;
        return '<text font-size="3" fill="black" font-family="Verdana" text-anchor="middle" alignment-baseline="baseline" x="' + cx + '" y="' + cy + '">New Year</text>';
      }

      function draw_legend(first, second, third) {
        const cx = 18;
        let cy = 0;
        if (bad_mobile)
          cy += 10;

        let content = '';
        //const cy3 = cy;
        //content += '<rect x="' + cx + '" y="' + cy3 + '" width="55" height="5" rx="0" fill="white" stroke="white" stroke-width="0.3" />';
        let cx2 = cx + 1.5;
        let cy2 = cy + 3 + 1;
        if (bad_mobile)
          cy2 -= 9;
        
        const cy4 = cy2;
        if (first)
          content += `<text font-size="3" fill="black" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${cx2}" y="${cy4}" font-weight="bold">${first}</text>`;
        else
          cx2 = cx2 - cx - 1.5;

        const cx5 = cx2 + 19;
        if (second)
          content += `<text font-size="3" fill="gray" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${cx5}" y="${cy4}" font-weight="bold">${second}</text>`;

        if (third) {
          if (second != third) {
            const cx6 = cx5 + 19;
            content += `<text font-size="3" fill="gray" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${cx6}" y="${cy4}" font-weight="bold-">${third}</text>`;
          }
        }

        return content
      }

      function draw_legend2(text, position) {
        console.log('to be optimized: position in essence is responsible only for color');
        const cx = 18;
        let cy = 0;
        if (bad_mobile)
          cy += 10;

        let cx2 = cx + 1.5;
        let cy2 = cy + 3 + 1;
        if (bad_mobile)
          cy2 -= 9;
        
        if (position == 1)
          return `<text font-size="3" fill="black" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${cx2}" y="${cy2}" font-weight="bold">${text}</text>`;
        
        const cx5 = cx2 + 19 * (number_of_mortality_charts_drawn);
        if (position == 2)
            return `<text font-size="3" fill="gray" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${cx5}" y="${cy2}" font-weight="bold">${text}</text>`;
        
        if (position == 3)
          return `<text font-size="3" fill="gray" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${cx5}" y="${cy2}" font-weight="bold-">${text}</text>`;
      }

      function draw_label_deaths() {
        const cx = calendar_years_numbers_width + calendar_step_horizontal;
        let cy = get_calendar_height() - number_of_years * calendar_step_vertical - calendar_weeks_numbers_height + 0;
        if (bad_mobile)
          cy += 10;

        let content = `<rect x="${cx}" y="${cy}" width="25" height="5" rx="0" fill="${color_base}" stroke="${color_base}" stroke-width="0.3" />`;
        const cy3 = cy + calendar_step_vertical;
        const cx2 = cx + 1.5;
        let cy2 = cy + 3 + 1;
        if (bad_mobile)
          cy2 -= 9;
        content += '<text font-size="3" fill="black" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="' + cx2 + '" y="' + cy2 + '" font-weight="bold-">Deaths at age</text>';
        return content
      }

      function draw_label_chances() {
        const cx2 = number_of_weeks_in_a_row * calendar_step_horizontal + calendar_years_numbers_width + 4;
        let cy = get_calendar_height() - number_of_years * calendar_step_vertical - calendar_weeks_numbers_height + 1;
        if (bad_mobile)
          cy += 10;
        const cx = cx2 - 29 - 5;
        let content = `<rect x="${cx}" y="${cy}" width="35" height="4" rx="0" fill="${color_base}" stroke="${color_base}" stroke-width="0.3" />`;
        let cy2 = cy + 3;
        if (bad_mobile)
          cy2 -= 9;
        content += '<text font-size="3" fill="black" font-family="Verdana" text-anchor="end" alignment-baseline="baseline" x="' + cx2 + '" y="' + cy2 + '" font-weight="bold-">Chance to die at age</text>';
        return content
      }

      function draw_weeks_numbers() {
        let content = '';

        for (let week = 1; week <= number_of_weeks_in_a_row; week++) {
          if (week % 4 == 0) { // add a marker for every 4-th week
            let x_offset = (week + 1) * calendar_step_horizontal + calendar_years_numbers_width;
            let cx = x_offset - circle_radius;
            let cy = get_calendar_height();
            if (bad_mobile)
              cy += 0;
            content += '<text font-size="3" fill="black" font-family="Verdana" text-anchor="middle" alignment-baseline="baseline" x="' + cx + '" y="' + cy +'" font-weight="bold">';
            content += week;
            content += '</text>';
          }
        }

        return content;
      }

      function draw_years_numbers(user_values) {
        const date = user_values['birthday'];
        const birthday_date = new Date(date);

        let content = '';

        for (let year = 1; year <= number_of_years; year++) {
          if (year % 5 == 0) { // add age marker for every 5-th year
            let y_offset = year * calendar_step_vertical + 1;
            if (bad_mobile)  // idk why on mobiles is calculated differently
              y_offset -= 1;

            const cy = get_calendar_height() - y_offset //+ circle_radius;
            const cy2 = cy - calendar_step_vertical;
            content += '<text font-size="3" fill="black" font-family="Verdana" text-anchor="end" alignment-baseline="baseline" x="15" y="' + cy2 + '">'

            const birthday_year = birthday_date.getFullYear();
            if ((birthday_date.getMonth() == 0 && birthday_date.getDate() <= 9) || 
                (birthday_date.getMonth() == 11 && birthday_date.getDate() > 25))  // in case of birthday during 1st week of January don't write 2004/05, but 2004
              content += birthday_year + year;
            else {
              const year_from = (birthday_year + year).toString();
              const year_to = (birthday_year + year + 1).toString();
              content +=  year_from + '/' + year_to.slice(2, 4);  // 2023/24
            }
            content += '</text>';
          }
        }

        return content;
      }

      function draw_ages_numbers() {
        let content = '';

        for (let year = 1; year <= number_of_years; year++) {
          if (year % 5 == 0) { // add age marker for every 5-th year
            let y_offset = year * calendar_step_vertical + 1;
            if (bad_mobile)  // idk why on mobiles is calculated differently
              y_offset -= 1;

            const cy = get_calendar_height() - y_offset //+ circle_radius;
            content += '<text font-size="3" fill="black" font-family="Verdana" text-anchor="end" alignment-baseline="baseline" x="15" y="' + cy + '" font-weight="bold">'
            content += year;
            content += '</text>';
          }
        }

        return content;
      }

      function coordinates_to_svg_pair_points(coordinates) {
        let vertical_offset = calendar_weeks_numbers_height + circle_radius;
        if (bad_mobile)  // idk why on mobiles is calculated differently
          vertical_offset -= 10;

        let points = '';
        for (let key in coordinates) {
          const value = coordinates[key];
          const vertical = get_calendar_height() - (key - 1) * calendar_step_vertical - vertical_offset;
          const horizontal = (value - 1) * calendar_step_horizontal + calendar_years_numbers_width + 10;
          points += horizontal + ',' + vertical + ' ';
        }
        return points;
      }

      function stacked_coordinates_to_svg_pair_points(coordinates) {
        let vertical_offset = calendar_weeks_numbers_height + 0;
        if (bad_mobile)  // idk why on mobiles is calculated differently
          vertical_offset -= 10;

        const first_dot_x = 1 * calendar_step_horizontal + calendar_years_numbers_width + 1;
        const first_dot_y = get_calendar_height() - 1 * calendar_step_vertical - vertical_offset + 5;
        let points = `${first_dot_x},${first_dot_y} `;
        for (let key in coordinates) {
          const value = coordinates[key];
          const vertical = get_calendar_height() - (key - 1) * calendar_step_vertical - vertical_offset;
          const horizontal = (value - 1) * calendar_step_horizontal + calendar_years_numbers_width + 10;
          points += horizontal + ',' + vertical + ' ';
        }
        const last_dot_x = 1 * calendar_step_horizontal + calendar_years_numbers_width + 0;
        const last_dot_y = get_calendar_height() - 90 * calendar_step_vertical - vertical_offset + 5;
        points += `${last_dot_x},${last_dot_y} `;
        return points;
      }

      function make_coordinates(max, array, age, position, scale_y) {
        let coordinates_dots = {};
        let coordinates_dots_before_age = {};
        let coordinates_dots_after_age = {};

        if (!scale_y)
          scale_y = 1;
        
        for (let year = 0; year < number_of_years; year++) {
          const value = array[year];
          let value_mapped_on_weeks;
          if (position == "right") 
            value_mapped_on_weeks = number_of_weeks_in_a_row - (value / max) * number_of_weeks_in_a_row * scale_y;
          else
            value_mapped_on_weeks = (value / max) * number_of_weeks_in_a_row * scale_y;

          coordinates_dots[year + 1] = value_mapped_on_weeks;  // +1 because year in data starts with 0, on chart with 1
          if (year <= age)
            coordinates_dots_before_age[year + 1] = value_mapped_on_weeks;
          if (year >= age)
            coordinates_dots_after_age[year + 1] = value_mapped_on_weeks;
        }
        
        return {
          'dots': coordinates_dots,
          'dots_before_age': coordinates_dots_before_age,
          'dots_after_age': coordinates_dots_after_age,
        };
      }

      function make_stacked_coordinates(array) {
        const max = 100;
        let coordinates_dots = {};
        for (let i = 0; i < years.length; i++) {
          const year = years[i];
          if (year == 2) // skip for better curve drawing
            continue;
          const value = array[i];
          let value_mapped_on_weeks = (value / max) * number_of_weeks_in_a_row;
          if (!value_mapped_on_weeks)
            value_mapped_on_weeks = (array[i-1] / max) * number_of_weeks_in_a_row;
          coordinates_dots[year] = value_mapped_on_weeks;  // +1 because year in data starts with 0, on chart with 1
        }        
        return {'dots': coordinates_dots};
      }

      function make_stacked_coordinates_inside_deaths(array) {
        const max = 100;
        const user_values = get_user_selected_parameters();
        const country_code = user_values.country_code;
        const sex = user_values.sex;

        let coordinates_dots = {};
        let max2 = get_peak_value(data_dx[country_code][sex][last_year_in_dataset_1]).value;
        for (let i = 0; i < years.length; i++) {
          const year = years[i];
          const value = array[i];
          let val = data_dx[country_code][sex][last_year_in_dataset_1][year - 1];
          //let coeff = val * 0.7 / max2;
          let coeff = val / max2;
          let value_mapped_on_weeks = coeff * (value / max) * number_of_weeks_in_a_row;
          if (!value_mapped_on_weeks)
            value_mapped_on_weeks = coeff * (array[i-1] / max) * number_of_weeks_in_a_row;
          
          coordinates_dots[year] = value_mapped_on_weeks;  // +1 because year in data starts with 0, on chart with 1
        }
        
        return {'dots': coordinates_dots};
      }

      function draw_polyline(coordinates, stroke, stroke_width, stroke_dasharray) {
        let content = `<polyline fill="none" stroke="${stroke}" stroke-width="${stroke_width}" stroke-linejoin="round" stroke-dasharray="${stroke_dasharray}" points="`;
        content += coordinates_to_svg_pair_points(coordinates);
        content += '"/>';

        return content;
      }

      function draw_stacked_polyline(coordinates, stroke) {
        let content = `<polyline opacity="1" fill="${stroke}" stroke-linejoin="round" points="`;
        content += stacked_coordinates_to_svg_pair_points(coordinates);
        content += '"/>';

        return content;
      }

      function draw_line(mdx_type, data, stroke, age, stroke_dasharray) {
        let content = '';

        let position = "left";
        let scale_y = 0.7;
        if (mdx_type == "mx") {
          position = "right";
          scale_y = 1;
        }
        let max = get_peak_value(data_all[mdx_type]).value;
        if (max < 100)
          max = 100;
        const coordinates = make_coordinates(max, data, age, position, scale_y);

        content += draw_polyline(coordinates.dots_before_age, antistroke, antistroke_width, stroke_dasharray);
        content += draw_polyline(coordinates.dots_after_age, stroke, stroke_width, stroke_dasharray);

        return content;
      }
      function draw_stacked_line(data, stroke, under_curve) {
        let content = '';
        let coordinates = {};
        if (under_curve)
          coordinates = make_stacked_coordinates_inside_deaths(data);
        else
          coordinates = make_stacked_coordinates(data);
        content += draw_stacked_polyline(coordinates.dots, stroke);
        return content;
      }

      function transform_fill_ranges_to_coordinates(fill_ranges, birthday_date) {
        let new_fill_ranges = [];
        for (let i = 0; i < fill_ranges.length; i++) {
          const range = fill_ranges[i];

          let new_range = {};
          new_range["fill"] = range["fill"];
          new_range["animate"] = range["animate"];
          new_range["stroke"] = range["stroke"];
          new_range["stroke_width"] = range["stroke_width"];

          // from
          if (!range["from"])
            new_range["from_week"] = 1;
          else if (Number.isInteger(range["from"]))
            new_range["from_week"] = (range["from"] - 1) * number_of_weeks_in_a_row + 1;
          else  // date format
            new_range["from_week"] = calculate_weeks_between(birthday_date, range["from"]);
        
          // to
          if (!range["to"])
            new_range["to_week"] = number_of_weeks_in_a_row * number_of_years;
          else if (Number.isInteger(range["to"]))
            new_range["to_week"] = range["to"] * number_of_weeks_in_a_row;
          else  // date format
            new_range["to_week"] = calculate_weeks_between(birthday_date, range["to"]);
          
          new_fill_ranges.push(new_range);
        }
        //console.log(new_fill_ranges)
        return new_fill_ranges;
      }

      function draw_label(data) {
        content = `<rect x="${data.rect.x}" y="${data.rect.y}" width="${data.rect.width}" height="4" rx="0" fill="${color_base}" stroke="${color_base}" stroke-width="0.3" />`;
        content += `<text font-size="3" fill="${data.text.fill}" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${data.text.x}" y="${data.text.y}" font-weight="${data.text.weight}">${data.text.text}</text>`;
        return content;
      }

      function draw_datasources() {
        if (bad_mobile) // idk why it works so ugly with links, so removed links for iOS 14
          return `<text font-size="3" fill="black" font-family="Verdana" text-anchor="end" alignment-baseline="baseline" x="276" y="5" font-weight="normal">Data sources: HMD, WHO</text>`;
        else
          return `<text font-size="3" fill="black" font-family="Verdana" text-anchor="end" alignment-baseline="baseline" x="276" y="5" font-weight="normal">Data sources: <a xlink:href="https://mortality.org" xlink:title="HMD website" xlink:show="new">HMD</a>, <a xlink:href="https://www.who.int/data/gho/data/themes/mortality-and-global-health-estimates/ghe-leading-causes-of-death" xlink:title="WHO GHO website" xlink:show="new">WHO</a></text>`;
      }

      function draw_special_age_label(data) {
        return `<text font-size="3" fill="${data.color}" font-family="Verdana" text-anchor="start" alignment-baseline="baseline" x="${data.x}" y="${data.y}" font-weight="${data.weight}">${data.text}</text>`;
      }

      function calculate_svg_height() {
        const ratio_current_svg_canvas = 521 / (316 + 20); // to fix
        const margins_svg_canvas = svg_margin * 2;
        const innerHeight = window.innerHeight - margins_svg_canvas;
        const innerWidth = window.innerWidth - margins_svg_canvas;
        if (innerHeight > innerWidth)  // if portrait, optimize by width in aspect ratio
          return (((innerWidth * ratio_current_svg_canvas) * 100) / innerHeight) + '%';
        else  // otherwise optimize by screen height, but 1.5 to zoom
          return innerHeight * 1.6 - 30 + 'px';
      }

      async function draw_circles(user_values) {
        let content = '';

        const date = user_values['birthday'];
        const birthday_date = new Date(date);

        let fill_ranges = [
          {"fill": "transparent"},
        ];

        const fill_ranges_transformed = transform_fill_ranges_to_coordinates(fill_ranges, birthday_date);

        let total_weeks = 1;
        for (let year = 1; year <= number_of_years; year++) {
          let y_offset = get_calendar_height() - year * calendar_step_vertical;
          if (bad_mobile)
            y_offset += 10;
          
          let cy = y_offset - circle_radius;
          for (let week = 1; week <= number_of_weeks_in_a_row; week++) {
            let cx = (week + 1) * calendar_step_horizontal + calendar_years_numbers_width - circle_radius;
            const rect_width = 3.5;
            const cx3 = cx - rect_width / 2;
            const cy3 = cy - rect_width / 2;
            content += `<rect x="${cx3}" y="${cy3}" width="${rect_width}" height="${rect_width}" rx="20"`;
            
            let circle_color = "";
            let stroke = "black";
            let stroke_width = "0.07";
            for (let i in fill_ranges_transformed) {
              const range = fill_ranges_transformed[i];
              if (range["from_week"] <= total_weeks && range["to_week"] >= total_weeks) {
                circle_color = range["fill"];
                if (range["stroke"])
                  stroke = range["stroke"];
                if (range["stroke_width"])
                  stroke_width = range["stroke_width"];
              }
            }

            content += 'fill="' + circle_color + '" ';
            content += 'stroke="' + stroke + '" stroke-width="' + stroke_width + '"/>';
            total_weeks++;
          }
        }

        return content;
      }

      async function draw_mortality_for_user_values(user_values) {
        const date = user_values['birthday'];
        const country_code = user_values['country_code'];
        const sex = user_values['sex'];

        const birthday_date = new Date(date);
        let birthday_year = birthday_date.getFullYear();

        await get_mortality_data(country_code, sex, birthday_year);
        const data_to_draw_mx_birthday = data_mx[country_code][sex][birthday_year];
        const data_to_draw_dx_birthday = data_dx[country_code][sex][birthday_year];
        let label_chart_first = `${country_code}${birthday_year}${sex}`.toUpperCase();

        let have_data_for_charts = true
        if (data_to_draw_dx_birthday.length == 0) {
          have_data_for_charts = false;
          label_chart_first = undefined;
        }
        
        const year_percentiles_dx_birthday = get_percentiles(data_to_draw_dx_birthday, percentiles_to_draw);

        const age = get_age(birthday_date);
        const special_ages = [1, 2, 3, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100, age + 1, number_of_years];  // to draw integral values for these years

        let total_weeks = 1;
        //let percentiles_labels = {};
        let labels = '';
        let labels_special_years = '';
        for (let year = 1; year <= number_of_years; year++) {
          let y_offset = get_calendar_height() - year * calendar_step_vertical;
          if (bad_mobile)
            y_offset += 10;
          
          let cy = y_offset - circle_radius;

          const cx2 = 19;
          const cx4 = cx2 + 10;
          let cy2 = cy + 1;
          if (bad_mobile)
            cy2 = cy2 - 10 + 1;

          for (let i = 0; i < percentiles_to_draw.length; i++) {
            let percentile = percentiles_to_draw[i];
            const cx5 = cx2 - 2;
            let cy5 = cy2 - 3;
            if (bad_mobile)
              cy5 = cy5 + 10 - 1;

            if (have_data_for_charts) {
              if (year == year_percentiles_dx_birthday[percentile]) {
                const l = {'rect': {'x': cx5, 'y': cy5, 'width': 10}, 'text': {'x': cx2, 'y': cy2, 'text': percentile + '%', 'fill': 'black', 'weight': 'bold'}};
                labels_percentiles[0][percentile] = l;
                //labels += draw_label(l);
              }
            }
          }

          // drawing labels for special ages
          if (special_ages.includes(year)) {
            let cy2 = cy + 1;
            if (bad_mobile)
              cy2 = cy2 - 10 + 1;
            let cx2 = calendar_step_horizontal * number_of_weeks_in_a_row + calendar_years_numbers_width + 10 - circle_radius;

            if (have_data_for_charts) {
              labels_special_years += draw_special_age_label({'color': 'black', 'x': cx2, 'y': cy2, 'weight': 'bold', 'text': data_mx[country_code][sex][birthday_year][year - 1].toFixed(1) + '%'});
              cx2 += 11;
              if (data_mx[country_code][sex][birthday_year][year - 1] > 10)
                cx2 += 2;
            }
          }
        }

        antistroke_width = 0.5;
        let content = '';
        if (have_data_for_charts) {
          antistroke = "black"
          content += draw_line("mx", data_to_draw_mx_birthday, "black", age);
          content += draw_line("dx", data_to_draw_dx_birthday, "black", age);
        }

        content += draw_legend2(label_chart_first, 1);
        content += labels;
        content += labels_special_years;

        number_of_mortality_charts_drawn++;
        return content;
      }

      async function draw_mortality_for_latest_year_user_values(user_values) {
        const date = user_values['birthday'];
        const country_code = user_values['country_code'];
        const sex = user_values['sex'];
        
        const birthday_date = new Date(date);
        let birthday_year = birthday_date.getFullYear();

        const data_to_draw_mx_latest = data_mx[country_code][sex][last_year_in_dataset_1];
        const data_to_draw_dx_latest = data_dx[country_code][sex][last_year_in_dataset_1];
        const label_chart_second = `${country_code}${last_year_in_dataset_1}${sex}`.toUpperCase();
        
        const year_percentiles_dx_latest = get_percentiles(data_to_draw_dx_latest, percentiles_to_draw);

        const age = get_age(birthday_date);
        const special_ages = [1, 2, 3, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100, age + 1, number_of_years];  // to draw integral values for these years

        let total_weeks = 1;
        let labels = '';
        let labels_special_years = '';
        for (let year = 1; year <= number_of_years; year++) {
          let y_offset = get_calendar_height() - year * calendar_step_vertical;
          if (bad_mobile)
            y_offset += 10;
          
          let cy = y_offset - circle_radius;

          const cx2 = 19;
          const cx4 = cx2 + 10;
          let cy2 = cy + 1;
          if (bad_mobile)
            cy2 = cy2 - 10 + 1;

          for (let i = 0; i < percentiles_to_draw.length; i++) {
            let percentile = percentiles_to_draw[i];
            const cx5 = cx2 - 2;
            let cy5 = cy2 - 3;
            if (bad_mobile)
              cy5 = cy5 + 10 - 1;

            if (year == year_percentiles_dx_latest[percentile]) {
              const l = {'rect': {'x': cx5, 'y': cy5, 'width': 10 + 10 * (number_of_mortality_charts_drawn)}, 'text': {'x': cx2 + 10 * (number_of_mortality_charts_drawn), 'y': cy2, 'text': percentile + '%', 'fill': 'gray', 'weight': 'bold'}};
              labels_percentiles[1][percentile] = l;
              //labels += draw_label(l);
            }
          }

          // drawing labels for special ages
          if (special_ages.includes(year)) {
            let cy2 = cy + 1;
            if (bad_mobile)
              cy2 = cy2 - 10 + 1;
            let cx2 = calendar_step_horizontal * number_of_weeks_in_a_row + calendar_years_numbers_width + 10 - circle_radius;

            cx2 += 11 * number_of_mortality_charts_drawn;
            if (data_mx[country_code][sex][birthday_year][year - 1] > 10)
                cx2 += 2 * number_of_mortality_charts_drawn;

            labels_special_years += draw_special_age_label({'color': 'gray', 'x': cx2, 'y': cy2, 'weight': 'bold', 'text': data_mx[country_code][sex][last_year_in_dataset_1][year - 1].toFixed(1) + '%'});
          }
        }

        antistroke = "gray"
        const latest = "gray"
        antistroke_width = 0.5;
        let content = '';
        content += draw_line("mx", data_to_draw_mx_latest, latest, age);
        content += draw_line("dx", data_to_draw_dx_latest, latest, age);

        content += draw_legend2(label_chart_second, 2);
        content += labels;
        content += labels_special_years;
        
        number_of_mortality_charts_drawn++;
        return content;
      }

      async function draw_mortality_to_compare_user_values(user_values) {
        const date = user_values['birthday'];
        const country_code = user_values['country_code'];
        const country_code_latest = user_values['country_code_latest'];
        const sex = user_values['sex'];
        const sex_to_compare = user_values['sex_to_compare'];

        const birthday_date = new Date(date);
        let birthday_year = birthday_date.getFullYear();

        const data_to_draw_mx_another_country = data_mx[country_code_latest][sex_to_compare][last_year_in_dataset_2];
        const data_to_draw_dx_another_country = data_dx[country_code_latest][sex_to_compare][last_year_in_dataset_2];
        const label_chart_third = `${country_code_latest}${last_year_in_dataset_2}${sex_to_compare}`.toUpperCase();

        const year_percentiles_dx_another_country = get_percentiles(data_to_draw_dx_another_country, percentiles_to_draw);

        const age = get_age(birthday_date);
        const special_ages = [1, 2, 3, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100, age + 1, number_of_years];  // to draw integral values for these years

        let total_weeks = 1;
        let labels = '';
        let labels_special_years = '';
        
        for (let year = 1; year <= number_of_years; year++) {
          let y_offset = get_calendar_height() - year * calendar_step_vertical;
          if (bad_mobile)
            y_offset += 10;
          
          let cy = y_offset - circle_radius;

          const cx2 = 19;
          const cx4 = cx2 + 10 + 10 * (number_of_mortality_charts_drawn - 1);
          let cy2 = cy + 1;
          if (bad_mobile)
            cy2 = cy2 - 10 + 1;

          for (let i = 0; i < percentiles_to_draw.length; i++) {
            let percentile = percentiles_to_draw[i];
            const cx5 = cx2 - 2;
            let cy5 = cy2 - 3;
            if (bad_mobile)
              cy5 = cy5 + 10 - 1;
            
            if (country_code != country_code_latest || sex != sex_to_compare) {
              if (year == year_percentiles_dx_another_country[percentile]) {
                const l = {'rect': {'x': cx5, 'y': cy5, 'width': 20 + 10 * (number_of_mortality_charts_drawn - 1)}, 'text': {'x': cx4, 'y': cy2, 'text': percentile + '%', 'fill': 'gray', 'weight': 'normal'}};
                labels_percentiles[2][percentile] = l;
                //labels += draw_label(l);
              }
            }
          }

          // drawing labels for special ages
          if (special_ages.includes(year)) {
            let cy2 = cy + 1;
            if (bad_mobile)
              cy2 = cy2 - 10 + 1;
            let cx2 = calendar_step_horizontal * number_of_weeks_in_a_row + calendar_years_numbers_width + 10 - circle_radius;

            if (country_code != country_code_latest || sex != sex_to_compare) {
              cx2 += 11 * number_of_mortality_charts_drawn;
              if (data_mx[country_code][sex][last_year_in_dataset_1][year - 1] > 10)
                cx2 += 2;
              if (data_mx[country_code][sex][birthday_year][year - 1] > 10)
                cx2 += 2 * (number_of_mortality_charts_drawn - 1);
              labels_special_years += draw_special_age_label({'color': 'gray', 'x': cx2, 'y': cy2, 'weight': 'normal', 'text': data_mx[country_code_latest][sex_to_compare][last_year_in_dataset_2][year - 1].toFixed(1) + '%'});
            }
          }
        }

        antistroke = "gray"
        const latest = "gray"
        stroke_width = 0.4;
        antistroke_width = 0.4;
        let content = '';
        if (country_code_latest != country_code || sex != sex_to_compare) {
          content += draw_line("mx", data_to_draw_mx_another_country, "gray", age, "4 2");
          content += draw_line("dx", data_to_draw_dx_another_country, "gray", age, "4 2");
          content += draw_legend2(label_chart_third, 3);
        }

        content += labels;
        content += labels_special_years;

        number_of_mortality_charts_drawn++;
        return content;
      }

      async function draw_causes_of_deaths() {
        await who_get();
        
        let content = '';        
        for (let j = who_causes_groups.length - 1; j >= 0 ; j--) {
          let cause = get_data_for_something(who_stacked_coordinates, who_causes_groups[j]);
          content += draw_stacked_line(cause, who_causes_colors[j]);
        }

        return content;
      }

      async function draw_causes_of_deaths_under_mortality_curve() {
        await who_get();
        
        let content = '';        
        for (let j = who_causes_groups.length - 1; j >= 0 ; j--) {
          let cause = get_data_for_something(who_stacked_coordinates, who_causes_groups[j]);
          content += draw_stacked_line(cause, who_causes_colors[j], true);
        }

        return content;
      }

      function get_parameters_from_url() {
        const current_url = new URL(window.location.href);
        const params = current_url.searchParams.get("p");
        let result = {'data_skin': data_skin_default};
        if (!params)
          return result;

        const splitted_params = params.split(',');
        for (let i = 0; i < url_params_items.length; i++) {
          if (!splitted_params[i])
            break;

          const parameter = url_params_items[i];
          result[parameter] = splitted_params[i];
        }

        let data_skin = splitted_params[5];
        if (!Object.keys(data_skins).includes(data_skin))
          result.data_skin = data_skin_default;

        if (!available_sexes.includes(result.sex))
          result.sex = sex_default;
        if (!available_sexes.includes(result.sex_to_compare))
          result.sex_to_compare = result.sex;

        return result;
      }

      function switch_off_loading() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('container').style.display = '';
        document.getElementById('qrcode').style.display = 'none';
      }
      function switch_on_loading() {
        document.getElementById('loading').style.display = '';
        document.getElementById('container').style.display = 'none';
        document.getElementById('qrcode').style.display = 'none';
      }

      function prepare_svg_canvas_for_print() {
        const svg_canvas = document.getElementById('svg_canvas');
        
        svg_canvas.style.height = '1000px';
        svg_canvas.style.marginTop = '16px';

        const user_values = get_user_selected_parameters()
        if (['cau', 'cam'].includes(user_values.data_skin))
          svg_canvas.style.marginLeft = '20px';
        else
          svg_canvas.style.marginLeft = '50px';
      }

      function prepare_qrcode_for_print() {
        const qrcode_image = document.getElementById('qrcode');

        const base_qrcode_margin_top = 890;
        const base_qrcode_margin_left = 479;

        let qrcode_margin_top = base_qrcode_margin_top;
        let qrcode_margin_left = base_qrcode_margin_left;

        qrcode_image.style.display = '';

        const user_values = get_user_selected_parameters()
        if (user_values.data_skin == 'cln') {
          qrcode_margin_top -= 1;
          qrcode_margin_left += 10;
        }
        else if (user_values.data_skin == 'lft')
          qrcode_margin_left += 5;
        else if (user_values.data_skin == 'cau')
          qrcode_margin_left -= 350;
        else if (user_values.data_skin == 'cam') {
          qrcode_margin_left += 35;
          qrcode_margin_top -= 8;
        }
        //else if (['mby', 'mbly', 'mc', 'all'].includes(user_values.data_skin))
        //  ;

        qrcode_image.style.top = qrcode_margin_top + 'px';
        qrcode_image.style.left = qrcode_margin_left + 'px';
      }

      function prepare_for_print() {
        prepare_svg_canvas_for_print();
        prepare_qrcode_for_print();

        if (document.getElementsByClassName('container').length > 0)
          document.getElementsByClassName('container')[0].classList.remove("container");
        if (document.getElementsByClassName('blink').length > 0)
          document.getElementsByClassName('blink')[0].classList.remove("blink");
        document.getElementById('controls').style.display = 'none';
        $('#downloadAsPDF').removeClass('fade');
        $('#downloadAsPDF').modal('hide');

        print();

        switch_on_loading();
        location.reload(); // because print adjustments breaks the page
      }

      function guess_the_country() {
        const browser_language = navigator.language || navigator.userLanguage;
        if (!browser_language)
          return;

        const browser_country = browser_language.toLowerCase().split('-')[1];
        if (!Object.keys(supported_countries).includes(browser_country))
          return;

        document.getElementById('country_code').value = browser_country;
        document.getElementById('country_code_latest').value = browser_country;
      }

      function transform_who_ages_causes_to_coordinates(who_ranges) {
        let coordinates = {};
        for (let i = 0; i < number_of_years; i++) {
          const who_age = who_map_age_to_groups[i];
          coordinates[i + 1] = who_ranges[who_age];
        }
        return coordinates;
      }

      function transform_coordinates_to_stacked_coordinates(coordinates, order) {
        let stacked_coordinates = {};
        for (let i = 0; i < years.length; i++) {
          if (coordinates[years[i]] == undefined)
            break;

          stacked_coordinates[i] = {};
          for (let j = 0; j < order.length; j++) {
            if (coordinates[years[i]][order[j]] == undefined) {
              if (j == 0)
                stacked_coordinates[i][order[j]] = 0;
              else
                stacked_coordinates[i][order[j]] = +(stacked_coordinates[i][order[j - 1]]);
            }
            else {
              if (j == 0)
                stacked_coordinates[i][order[j]] = +(coordinates[years[i]][order[j]][1]);
              else
                stacked_coordinates[i][order[j]] = +(coordinates[years[i]][order[j]][1] + stacked_coordinates[i][order[j - 1]]);
            }
          }
        }
        //console.log(stacked_coordinates)
        return stacked_coordinates;
      }

      function get_data_for_something(stacked_coordinates, something) {
        let data = [];
        for (let i = 0; i < number_of_years; i++) {
          if (!stacked_coordinates[i])
            break;
          data.push(stacked_coordinates[i][something]);
        }
        return data;
      }

      function who_get() {
        const user_values = get_user_selected_parameters();
        const sex = user_values.sex;
        let year = last_year_in_dataset_1;
        if (year > 2019)
          year = 2019;
        const country = supported_countries[user_values.country_code].who_country_code;

        const who_url = `https://frontdoor-l4uikgap6gz3m.azurefd.net/DEX_CMS/GHE_FULL?&$top=20000&$orderby=VAL_DEATHS_RATE100K_NUMERIC desc&$select=DIM_COUNTRY_CODE,DIM_GHECAUSE_TITLE,DIM_YEAR_CODE,DIM_SEX_CODE,DIM_AGEGROUP_CODE,VAL_DEATHS_COUNT_NUMERIC,ATTR_POPULATION_NUMERIC,VAL_DEATHS_RATE100K_NUMERIC&$filter=FLAG_RANKABLE eq 1 and DIM_COUNTRY_CODE eq '${country}' and DIM_SEX_CODE eq '${who_sexes_map[sex]}' and DIM_YEAR_CODE eq '${year}'`;

        return fetch(who_url)
          .then((response) => response.text())
          .then((data) => {
            const data_values = JSON.parse(data).value;
            
            let population_total = {};
            let deaths_total = {};
            for (let i = 0; i < data_values.length; i++) {
              const record = data_values[i];
              const deaths = record.VAL_DEATHS_COUNT_NUMERIC;
              if (deaths == 0)
                continue;
              
              const age = record.DIM_AGEGROUP_CODE.replace('YEARS', '');
              if (deaths_total[age])
                deaths_total[age] += deaths;
              else
                deaths_total[age] = deaths;

              if (!population_total[age])
                population_total[age] = record.ATTR_POPULATION_NUMERIC;
            }

            let who_ages_causes = {};
            for (let i = 0; i < data_values.length; i++) {
              const record = data_values[i];
              const age = record.DIM_AGEGROUP_CODE.replace('YEARS', '');
              const deaths = record.VAL_DEATHS_COUNT_NUMERIC;
              const percentile = deaths * 100 / deaths_total[age]; // %
              const chance_to_die = deaths * 100 / population_total[age]; // %
              const cause = record.DIM_GHECAUSE_TITLE;
              
              if (percentile < 0.01)
                ;///continue;

              const group = who_map_causes_to_groups[cause];
              if (group) {
                if (who_ages_causes[age]) {
                  if (who_ages_causes[age][group]) {
                    who_ages_causes[age][group][0] += deaths;
                    who_ages_causes[age][group][1] = who_ages_causes[age][group][0] * 100 / deaths_total[age];
                  }
                  else
                    who_ages_causes[age][group] = [deaths, deaths * 100 / deaths_total[age]];
                }
                else
                  who_ages_causes[age] = {[group]: [deaths, deaths * 100 / deaths_total[age]]};
              }
              else
                ; //console.log(0); //console.log(cause);
            }
            let coordinates = transform_who_ages_causes_to_coordinates(who_ages_causes);
            who_stacked_coordinates = transform_coordinates_to_stacked_coordinates(coordinates, who_causes_groups);
          }
        );
      }

      function fill_lifetime_circles(user_values) {
        let content = '';

        const date = user_values['birthday'];
        const birthday_date = new Date(date);

        const today = new Date();
        const next_week = new Date();
        next_week.setDate(today.getDate() + 7);
        let fill_ranges = [ // init
          {"fill": "skyblue", "to": today, "stroke_width": "0.2"},
          {"fill": "snow", "from": next_week, "to": next_week, "animate": "blink"},
        ];

        const fill_ranges_transformed = transform_fill_ranges_to_coordinates(fill_ranges, birthday_date);

        let total_weeks = 1;
        for (let year = 1; year <= number_of_years; year++) {
          let y_offset = get_calendar_height() - year * calendar_step_vertical;
          if (bad_mobile)
            y_offset += 10;
          
          let cy = y_offset - circle_radius;
          for (let week = 1; week <= number_of_weeks_in_a_row; week++) {
            let cx = (week + 1) * calendar_step_horizontal + calendar_years_numbers_width - circle_radius;
            const rect_width = 3.5;
            const cx3 = cx - rect_width / 2;
            const cy3 = cy - rect_width / 2;
            
            let circle_color = "";
            let stroke = "black";
            let stroke_width = "0.07";
            for (let i in fill_ranges_transformed) {
              const range = fill_ranges_transformed[i];
              circle_color = range["fill"];
              if (range["from_week"] <= total_weeks && range["to_week"] >= total_weeks) {
                content += `<rect x="${cx3}" y="${cy3}" width="${rect_width}" height="${rect_width}" rx="20" `;
                if (range["stroke"])
                  stroke = range["stroke"];
                if (range["stroke_width"])
                  stroke_width = range["stroke_width"];
              }
              if (range["to_week"] == total_weeks && range["animate"] == "blink") { // blink current week
                content += 'class="blink" ';
              }

              content += 'fill="' + circle_color + '" ';
              content += 'stroke="' + stroke + '" stroke-width="' + stroke_width + '" ';              
              content += '/>';
            }
            total_weeks++;
          }
        }

        return content;
      }

      function draw_new_year_dots(user_values) {
        let content = '';
        const date = user_values['birthday'];
        const birthday_date = new Date(date);
        let birthday_year = birthday_date.getFullYear();

        const new_year_dot_color_above_the_age = "black";
        const new_year_dot_color_below_the_age = "black";

        const week_new_year = calculate_new_year_week(birthday_date);

        const age = get_age(birthday_date);
        let total_weeks = 1;
        for (let year = 1; year <= number_of_years; year++) {
          let y_offset = get_calendar_height() - year * calendar_step_vertical;
          if (bad_mobile)
            y_offset += 10;
          
          let cy = y_offset - circle_radius;
          for (let week = 1; week <= number_of_weeks_in_a_row; week++) {
            let cx = (week + 1) * calendar_step_horizontal + calendar_years_numbers_width - circle_radius;
            const rect_width = 3.5;
            const cx3 = cx - rect_width / 2;
            const cy3 = cy - rect_width / 2;

            if (week == week_new_year) {  // dot for a new year week
              let dot_color = new_year_dot_color_above_the_age;
              if (year <= age) {
                dot_color = new_year_dot_color_below_the_age;
              }
              if (year == age + 1) {
                if (week_new_year < calculate_weeks_between(birthday_date, new Date()) % number_of_weeks_in_a_row) {
                  dot_color = new_year_dot_color_below_the_age;
                }
              }

              content += `<circle cx="${cx}" cy="${cy}" r="0.2" fill="${dot_color}" stroke="${dot_color}" stroke-width="0.2"/>`;
            }

            total_weeks++;
          }
        }
        return content;  
      }

      function compose_legend_for_causes_of_deaths_colors() {
        const user_values = get_user_selected_parameters();
        let content = '<li><b>Colors explanation</b>: <br>';
        for (let i = 0; i < who_causes_groups.length; i++) {
          const cause = who_causes_groups[i];
          const cause_color = who_causes_colors[i];
          if (cause == 'Maternal causes' && user_values.sex != 'f')
            continue;
          content += `<span style="background: ${cause_color};">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> ${cause}<br>`;
        }
        content += '</li>';
        return content;
      }

      function compose_legend(user_values) {
        const data_skin = user_values['data_skin'];
        let legend = '<ul>';

        let sex = 'males';
        if (user_values.sex == 'f')
          sex = 'females';

        let sex_to_compare = 'males';
        if (user_values.sex_to_compare == 'f')
          sex_to_compare = 'females';

        const year_of_birth = get_year_from_date(user_values.birthday);
        const country_name = supported_countries[user_values.country_code].country_name;
        const country_name_compare = supported_countries[user_values.country_code_latest].country_name;

        let compare = false;
        if (country_name != country_name_compare || sex != sex_to_compare)
          compare = true;

        if (['cln', 'lft', 'mby', 'mbly', 'mc', 'all', 'cau-', 'cam-', ].includes(data_skin))
          legend += `<li><b>Each ring</b> &mdash; is a week;</li><li><b>Each line of rings</b> &mdash; is a year (52 weeks);</li>`;
        if (['lft', 'all', ].includes(data_skin))
          legend += `<li><b>Each filled circle</b> &mdash; is a passed week of life;</li>`;
        if (['lft', 'all', ].includes(data_skin))
          legend += `<li><b>Blinking circle</b> &mdash; is a current week;</li>`;
        if (['lft', 'mby', 'mbly', 'mc', 'all', ].includes(data_skin))
          legend += `<li><b>Dot in a ring / circle</b> &mdash; is a New Year week;</li>`;
        if (['mby'].includes(data_skin))
          legend += `<li><b>Left line</b> &mdash; is a "Deaths at age" distribution for ${country_name}, ${sex} in ${year_of_birth};</li><li><b>Right line (and digits)</b> &mdash; is a "Chance to die at age" distribution for ${country_name}, ${sex} in ${year_of_birth};</li>`;
        if (['mbly', ].includes(data_skin))
          legend += `<li><b>Left lines</b> &mdash; are "Deaths at age" distributions for ${country_name}, ${sex} in ${year_of_birth} and ${country_name}, ${sex} in ${last_year_in_dataset_1};</li><li><b>Right lines</b> &mdash; are "Chance to die at age" distributions for the same dataset: ${country_name}, ${sex} in ${year_of_birth} and ${country_name}, ${sex} in ${last_year_in_dataset_1};</li>`;
        if (['mc', ].includes(data_skin))
          if (compare)
            legend += `<li><b>Left lines</b> &mdash; are "Deaths at age" distributions for ${country_name}, ${sex} in ${last_year_in_dataset_1} and ${country_name_compare}, ${sex_to_compare} in ${last_year_in_dataset_2};</li><li><b>Right lines (and digits)</b> &mdash; are "Chance to die at age" distributions for the same dataset: ${country_name}, ${sex} in ${last_year_in_dataset_1} and ${country_name_compare}, ${sex_to_compare} in ${last_year_in_dataset_2};</li>`;
          else
            legend += `<li><b>Left line</b> &mdash; is "Deaths at age" distribution for ${country_name}, ${sex} in ${last_year_in_dataset_1};</li><li><b>Right line (and digits)</b> &mdash; is "Chance to die at age" distribution for the same dataset: ${country_name}, ${sex} in ${last_year_in_dataset_1};</li>`;
        if (['all', ].includes(data_skin))
          if (compare)
            legend += `<li><b>Left lines</b> &mdash; are "Deaths at age" distributions for ${country_name}, ${sex} in ${year_of_birth} and ${last_year_in_dataset_1} and ${country_name_compare}, ${sex_to_compare} in ${last_year_in_dataset_2};</li><li><b>Right lines (and digits)</b> &mdash; are "Chance to die at age" distributions for the same dataset: ${country_name}, ${sex} in ${year_of_birth} and ${last_year_in_dataset_1} and ${country_name_compare}, ${sex_to_compare} in ${last_year_in_dataset_2};</li>`;
          else
            legend += `<li><b>Left lines</b> &mdash; are "Deaths at age" distributions for ${country_name}, ${sex} in ${year_of_birth} and ${last_year_in_dataset_1};</li><li><b>Right lines (and digits)</b> &mdash; are "Chance to die at age" distributions for the same dataset: ${country_name}, ${sex} in ${year_of_birth} and ${last_year_in_dataset_1};</li>`;
        if (['mbly', 'all', ].includes(data_skin))
          legend += `<li><b>Black bold (solid) lines and digits</b> &mdash; is the data for ${country_name}, ${year_of_birth}, ${sex};</li>`;
        if (['mbly', 'mc', 'all', ].includes(data_skin))
          legend += `<li><b style="color: gray;">Gray bold (solid) lines and digits</b> &mdash; is the data for ${country_name}, ${last_year_in_dataset_1}, ${sex};</li>`;
        if (compare)
          if (['mc', 'all', ].includes(data_skin))
            legend += `<li><span style="color: gray;">Gray thin (dashed) lines and digits</span> &mdash; is for ${country_name_compare}, ${last_year_in_dataset_2}, ${sex_to_compare};</li>`;
        if (['mby', ].includes(data_skin))
          legend += `<li><b>50%, 80%, 90%</b> on the left &mdash; are integrals for "Deaths at age" chart: how many ${sex} (of all died ${sex} in ${country_name} in ${year_of_birth}) have died by that age;</li>`;
        if (['mbly', ].includes(data_skin))
          legend += `<li><b>50%, 80%, 90%</b> on the left &mdash; are integrals for "Deaths at age" charts: how many ${sex} (of all died ${sex} in ${country_name} in ${year_of_birth} and ${last_year_in_dataset_1}) have died by that age;</li>`;
        if (['mc', ].includes(data_skin))
          if (compare)
            legend += `<li><b>50%, 80%, 90%</b> on the left &mdash; are integrals for "Deaths at age" charts: how many (of all died ${sex} in ${country_name} in ${last_year_in_dataset_1} and ${sex_to_compare} in ${country_name_compare} in ${last_year_in_dataset_2}) have died by that age;</li>`;
          else
            legend += `<li><b>50%, 80%, 90%</b> on the left &mdash; are integrals for "Deaths at age" charts: how many ${sex} (of all died ${sex} in ${country_name} in ${last_year_in_dataset_1}) have died by that age;</li>`;
        if (['all', ].includes(data_skin))
          if (compare)
            legend += `<li><b>50%, 80%, 90%</b> on the left &mdash; are integrals for "Deaths at age" charts: how many (of all died ${sex} in ${country_name} in ${year_of_birth} and in ${last_year_in_dataset_1} and ${sex_to_compare} in ${country_name_compare} in ${last_year_in_dataset_2}) have died by that age;</li>`;
          else
            legend += `<li><b>50%, 80%, 90%</b> on the left &mdash; are integrals for "Deaths at age" charts: how many (of all died ${sex} in ${country_name} in ${year_of_birth} and in ${last_year_in_dataset_1}) have died by that age;</li>`;
        if (['mby', 'mbly', 'all', ].includes(data_skin))
          legend += `<li><b>${user_values.country_code.toUpperCase()}${year_of_birth}${user_values.sex.toUpperCase()}</b> in the top left corner &mdash; is a "smart legend" that means: ${country_name}, data for ${year_of_birth} year, ${sex};</li>`;
        if (['mc', ].includes(data_skin))
          legend += `<li><b>${user_values.country_code.toUpperCase()}${last_year_in_dataset_1}${user_values.sex.toUpperCase()}</b> in the top left corner &mdash; is a "smart legend" that means: ${country_name}, data for ${last_year_in_dataset_1} year, ${sex};</li>`;
        if (['cau', 'cam'].includes(data_skin)) {
          legend += `<li><b>Left lines</b> &mdash; are "Causes of Deaths at age" distributions stacked and shaped by a Mortality curve for ${country_name}, ${sex} and ${last_year_in_dataset_1} latest data-available year;</li>`;
          legend += compose_legend_for_causes_of_deaths_colors();
        }

        legend += '</ul>';
        return legend;
      }

      const data_skins = {
        'cln': [draw_weeks_numbers, draw_ages_numbers, draw_circles, ],
        'lft': [draw_weeks_numbers, draw_ages_numbers, draw_years_numbers, draw_circles, fill_lifetime_circles, draw_label_new_year, draw_new_year_dots],
        'mby': [draw_weeks_numbers, draw_ages_numbers, draw_years_numbers, draw_circles, draw_mortality_for_user_values, draw_datasources, draw_label_chances, draw_label_deaths, draw_label_new_year, draw_new_year_dots, draw_labels_percentiles],
        'mbly': [draw_weeks_numbers, draw_ages_numbers, draw_years_numbers, draw_circles, draw_mortality_for_user_values, draw_mortality_for_latest_year_user_values, draw_datasources, draw_label_chances, draw_label_deaths, draw_label_new_year, draw_new_year_dots, draw_labels_percentiles],
        'mc': [draw_weeks_numbers, draw_ages_numbers, draw_years_numbers, draw_circles, draw_mortality_for_latest_year_user_values, draw_mortality_to_compare_user_values, draw_datasources, draw_label_chances, draw_label_deaths, draw_label_new_year, draw_new_year_dots, draw_labels_percentiles],
        //'all': [draw_calendar, ],
        'all': [draw_weeks_numbers, draw_ages_numbers, draw_years_numbers, draw_circles, fill_lifetime_circles, draw_mortality_for_user_values, draw_mortality_for_latest_year_user_values, draw_mortality_to_compare_user_values, draw_datasources, draw_label_chances, draw_label_deaths, draw_label_new_year, draw_new_year_dots, draw_labels_percentiles],
        'cau': [draw_weeks_numbers, draw_ages_numbers, draw_causes_of_deaths, draw_circles, draw_datasources, ],
        'cam': [draw_weeks_numbers, draw_ages_numbers, draw_causes_of_deaths_under_mortality_curve, draw_circles, draw_datasources, ],
        'cau2': [draw_weeks_numbers, draw_ages_numbers, draw_years_numbers, draw_circles, draw_new_year_dots, draw_causes_of_deaths, draw_mortality_for_latest_year_user_values, draw_label_chances, draw_label_deaths, draw_label_new_year, draw_labels_percentiles, draw_datasources, ],
        //'mortality': [circles, draw_mortality_lines, ],
        //'lifetime+mortality': [circles, fill_lifetime_circles, draw_mortality_lines, ],
        //'causes': [draw_causes_lines, circles, ],
        //'causes+lifetime': [draw_causes_lines, circles, fill_lifetime_circles, ],
        //'causes+lifetime+mortality': [draw_causes_lines, circles, fill_lifetime_circles, draw_mortality_lines, ],
        //'causes+fit+mortality': [draw_causes_lines_fit_mortality, circles, fill_lifetime_circles, draw_mortality_lines, ],
        //'causes+fit+lifetime': [draw_causes_lines_fit_mortality, circles, fill_lifetime_circles, ],
      };

      function adjust_calendar_offsets_for_data_skin(data_skin) {
        number_of_years = 101;

        if (data_skin == 'cln') {
          calendar_top_offset = 5;
          calendar_width_offset = 20;
        }
        else if (data_skin == 'lft') {
          calendar_top_offset = 10;
          calendar_width_offset = 20;
        }
        else if (data_skin == 'mby') {
          calendar_top_offset = 15;
          calendar_width_offset = 35;
        }
        else if (data_skin == 'mbly') {
          calendar_top_offset = 15;
          calendar_width_offset = 48;
        }
        else if (data_skin == 'mc' || data_skin == 'all') {
          calendar_top_offset = 15;
          calendar_width_offset = 60;
        }
        else if (data_skin == 'cau' || data_skin == 'cam') {
          calendar_top_offset = 15;
          calendar_width_offset = 20;
          number_of_years = 89;
        }
      }
      function adjust_calendar_controls_offset() {
        document.getElementById('controls').style.marginTop = '25px';
      }

      function hide_all_calendar_controls() {
        available_controls.forEach((element_id => {
          document.getElementById('wrapper_' + element_id).style.display = 'none';
        }));
      }

      function adjust_country_code_label(data_skin) {
        let country_code_label = 'Motherland (with data-available years):';
        if (['cau', 'cam'].includes(data_skin))
          country_code_label = 'Country (with data-available years):';

        document.getElementById('country_code_label').innerHTML = country_code_label;
      }

      function adjust_calendar_controls_for_data_skin(data_skin) {
        hide_all_calendar_controls();

        let enable_controls = [];
        if (data_skin == 'cln')
          ;
        else if (data_skin == 'all')
          enable_controls = available_controls;
        else if (data_skin == 'lft')
          enable_controls.push('birthday')
        else if (['mby', 'mbly', 'cau-', 'cam-'].includes(data_skin))
          enable_controls = ['sex', 'birthday', 'country_code'];
        else if (['cau', 'cam'].includes(data_skin))
          enable_controls = ['sex', 'country_code'];
        else if (data_skin == 'mc')
          enable_controls = ['sex', 'country_code', 'country_code_latest', 'sex_to_compare'];

        adjust_country_code_label(data_skin);

        enable_controls.forEach((element_id => {
          document.getElementById('wrapper_' + element_id).style.display = '';
        }));
      }

      function start_svg_image_calendar() {
        let ch = get_calendar_height() + 1;
        if (bad_mobile)
          ch += calendar_weeks_numbers_height + calendar_new_year_label_height; // idk why
        const svg_height = calculate_svg_height();
        let svg_width = 'auto';
        if (bad_mobile) // on mobile safari sucks, on desktop safari not
          svg_width = `calc(100% - ${svg_margin * 2}px);`;

        return `<svg id="svg_canvas" height="${svg_height}" viewBox="0 0 ${get_calendar_width()} ${ch}" xmlns="http://www.w3.org/2000/svg" style="margin: ${svg_margin}px; margin-top: 10px; width: ${svg_width};">`;
      }
      function finish_svg_image_calendar() {
        return '</svg>';
      }

      async function preload_data(user_values) {
        const date = user_values['birthday'];
        const country_code = user_values['country_code'];
        const country_code_latest = user_values['country_code_latest'];
        const sex = user_values['sex'];
        const sex_to_compare = user_values['sex_to_compare'];
        const data_skin = user_values['data_skin'];

        const birthday_date = new Date(date);
        let birthday_year = birthday_date.getFullYear();
        
        if (['mc', 'all'].includes(data_skin)) {
          //if (country_code_latest != country_code || sex != sex_to_compare) {
            await get_mortality_data(country_code_latest, sex_to_compare); // to fix last year will be calculated 
            last_year_in_dataset_2 = last_year_in_dataset;
          //}
        }
        if (['mby', 'mbly', 'mc', 'all', 'cau', 'cam'].includes(data_skin)) {
          await get_mortality_data(country_code, sex);
          last_year_in_dataset_1 = last_year_in_dataset;

          await get_mortality_data(country_code, sex, birthday_year);
          last_year_in_dataset = last_year_in_dataset;
        }
        //console.log(data_skin, last_year_in_dataset_2)
      }

      function reset_globals() {
        data_all = {'mx': [], 'dx': []};
        number_of_mortality_charts_drawn = 0;
        labels_percentiles = [{}, {}, {}];
      }

      async function init_calendar(user_values) {
        reset_globals();

        await preload_data(user_values);

        const data_skin = user_values['data_skin'];
        adjust_calendar_offsets_for_data_skin(data_skin);
        adjust_calendar_controls_for_data_skin(data_skin);
        adjust_calendar_controls_offset();

        let svg_image_calendar = start_svg_image_calendar();

        const what_to_draw = data_skins[data_skin];
        for (let layer = 0; layer < what_to_draw.length; layer++)
          svg_image_calendar += await what_to_draw[layer](user_values);

        svg_image_calendar += finish_svg_image_calendar();

        document.getElementById("calendar").innerHTML = svg_image_calendar;
        document.getElementById("explanation_text").innerHTML = `<p>${explanation_texts[data_skin]}</p>`;
        document.getElementById("value_text").innerHTML = `<p>${values_texts[data_skin]}</p>`;
        document.getElementById("legend_text").innerHTML = compose_legend(user_values);

        switch_off_loading();
      }

      function build_selectors_options_for_countries() {
        build_selector_options_for_country_code('country_code');
        build_selector_options_for_country_code('country_code_latest');
      }

      function build_selector_options_for_country_code(element_id) {
        let options = '';
        for (let country_code in supported_countries) {
          const country = supported_countries[country_code];
          options += `<option value="${country_code}">${country.country_name}`;
          if (element_id == 'country_code')
            options += ` (${country.data_years_from}-${country.data_years_to})`;

          options += `</option>`;
        }
        document.getElementById(element_id).innerHTML = options;
      }

      function update_download_text_for_mobile() {
        document.getElementById('download_as_pdf').innerHTML = '<p>Downloading this calendar as an optimized for printing PDF file is available only on Desktop. Open this URL on your Desktop computer to be able to download this calendar as PDF.</p>';
      }

      function draw_labels_percentiles() {
        let content = '';
        for (let i = labels_percentiles.length - 1; i >= 0; i--) {  // in reverse order due to labels overlap
          if (Object.keys(labels_percentiles[i]).length != 0) {
            percentiles_to_draw.forEach((percentile) => {
              content += draw_label(labels_percentiles[i][percentile]);
            });
          }
        }
        return content;
      }

      window.onload = function() {
        build_selectors_options_for_countries();
        if (is_mobile)
          update_download_text_for_mobile();

        let user_values = get_parameters_from_url(); // get what's possible from url (including incomplete url)
        set_user_selected_parameters(user_values); // set what's possible in html

        if (!user_values.country_code) // set country value based on locale if not set and applicable
          guess_the_country();
        
        user_values = get_user_selected_parameters(); // read from html as usual
        qrcode = init_qrcode(user_values, 67); // other sizes: 75 (4 dots left), 84 (3 dots left)
        init_calendar(user_values);
      };
    </script>
  </head>
  <body>
    <div id="loading">
      <p>📅 Loading Calendarium...</p>
    </div>
    <div id="qrcode" style="position: absolute; padding: 5px; background-color: white; top: 84.7%; left: 64.6%; border-radius: 0px; display: none;"></div>
    <div class="container" id="container" style="display: none">
      <div class="row justify-content-center">
        <div class="col-xxl-7 col-xl-7 col-lg-7 col-md-12 col-sm-12" style="">
          <div id="calendar"></div>
        </div>
      
        <div class="col-xxl-3 col-xl-3 col-lg-3 col-md-8 col-sm-10 col-11">
          <div id="controls" style="color: black; font-size: 0.7em; margin-top: 10px;">
            <h4>Configure</h4>
            <div id="wrapper_data_skin" class="form-floating controls_wrapper">
              <label for="data_skin">Data-skin:</label>
              <select id="data_skin" onchange="redraw_calendar();" class="form-control form-select form-select-sm">
                <option value="cln">Clean</option>
                <option value="lft">Fill Lifetime</option>
                <option value="mby">Mortality for a birth year</option>
                <option value="mbly" selected>Mortality for a birth vs. latest years</option>
                <option value="mc">Compare mortality for countries & sexes</option>
                <option value="all">All above together</option>
                <option value="cau">Causes of deaths</option>
                <option value="cam">Causes of deaths under Mortality curve</option>
              </select>
            </div>

            <div id="wrapper_birthday" class="form-floating controls_wrapper">
              <label>Date of birth:</label>
              <input id="birthday" type="date" value="1990-01-01" onchange="redraw_calendar();" class="form-control form-select- form-select-sm">
            </div>

            <div id="wrapper_country_code" class="form-floating controls_wrapper">
              <label id="country_code_label">Motherland (with data-available years):</label>
              <select id="country_code" onchange="change_country_of_birth();" class="form-control form-select form-select-sm"></select>
            </div>

            <div id="wrapper_sex" class="form-floating controls_wrapper">
              <label>Sex at birth:</label>
              <select id="sex" onchange="change_sex();" class="form-control form-select form-select-sm">
                <option value="m" selected>Male</option>
                <option value="f">Female</option>
              </select>
            </div>

            <div id="wrapper_country_code_latest" class="form-floating controls_wrapper">
              <label>Country mostly lived in during last years<br> or plan to relocate for a living:</label>
              <select id="country_code_latest" onchange="redraw_calendar();" class="form-control form-select form-select-sm xl_country_code"></select>
            </div>

            <div id="wrapper_sex_to_compare" class="form-floating controls_wrapper">
              <label>Sex at birth to compare with:</label>
              <select id="sex_to_compare" onchange="redraw_calendar();" class="form-control form-select form-select-sm">
                <option value="m" selected>Male</option>
                <option value="f">Female</option>
              </select>
            </div>

            <div id="explanation_section" style="margin-top: 25px;">
              <h4>Legend</h4>
              <div id="legend_text"></div>
              
              <h4>What is this</h4>
              <div id="explanation_text"></div>
              
              <h4>Value of this data-skin</h4>
              <div id="value_text"></div>

              <h4>Download</h4>
              <div id="download_as_pdf" style="margin-bottom: 25px;">
                <p>Download this calendar as an optimized for printing PDF file and print it any size.</p><p>Printed version of the calendar also has a <b>QR&#8209;code</b> &mdash; so you can visit an online version of the calendar with it's all latest updates and data-skins right from the wall at any time of your life.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#downloadAsPDF">Download as PDF</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="downloadAsPDF" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="downloadAsPDFLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="downloadAsPDFLabel">Download as PDF</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Use Google Chrome web browser to get the best results.</p>
              <p>While saving your PDF choose A4 paper size even if you plan to print calendar in A3/A2/A1/A0 sizes later. PDF is a vector graphics and calendar quality will not be affected.</p>
              <p>Read a step-by-step instruction below (it will not be available to you after clicking on a "<a href="#" onclick="prepare_for_print();">Save as PDF</a>" button):</p>
              <ol>
                <li>In an opened "Print" dialogue window set:
                    <ul>
                      <li>Destination: Save as PDF</li>
                    </ul>
                  </li>
                <li>Expand "More settings" section and set:
                  <ul>
                    <li>Paper size: A4</li>
                    <li>Margins: Default</li>
                    <li>Headers and footers: uncheck</li>
                    <li>Background graphics: uncheck</li>
                  </ul>
                </li>
                <li>Make sure that in a preview window calendar looks good;</li>
                <li>Click "Save" button in a "Print" dialogue window;</li> 
                <li>(optional) Give a custom name to a PDF file;</li> 
                <li>Click "Save" button in a "Save file" window.</li>
              </ol>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="prepare_for_print();">Save as PDF</button>
            </div>
          </div>
        </div>
      </div>
      <!--div class="row justify-content-center">
        <div class="col-lg-5 col-md-8 col-sm-10 col-11">
          <div id="faq" style="display: none;">
            <h1>FAQ:</h1>
            <p>
                <b>Q:</b> Where is a legend?<br>
                <b>A:</b> It's in the left top corner of a calendar.
            </p>
            <p class="has_list">
                <b>Q:</b> What does <b>PL2000F</b> mean in a legend?<br>
                <b>A:</b> <b>PL</b> means "Poland", <b>2000</b> means "data year", <b>F</b> means "Female".
                Colors mean: 
                <ul>
                  <li><b>Bold black</b> means "data for a birthday year", </li>
                  <li><b style="color: gray;">Bold gray</b> means "last data-available year for the origin country and sex at birth",</li>
                  <li><span style="color: gray;">Thin gray</span> (appears if compare-to country and/or sex are different) means "data for a compare-to country and/or sex".</li>
                </ul>
            </p>
            <p>
                <b>Q:</b> What are the charts on the left and on the right?<br>
                <b>A:</b> Left charts are "Deaths by age" and right ones are "Chance to die at age". 
            </p>
            <p>
                <b>Q:</b> What do these charts show?<br>
                <b>A:</b> Charts on the left ("Deaths by age") show how many people (of a particular sex in a particular country) have died on a specified year. Charts on the right ("Chance to die at age") show how many people of each age (among all the people of that age and sex in that particular country) have died on a specified year.
            </p>
            <p class="has_list">
                <b>Q:</b> Why do we have some "random year" chart as well?<br>
                <b>A:</b> This is not a "random year" chart, but "latest data-available year" chart for a specified country and sex:
                <ul>
                  <li>Solid <b>black bold</b> line (and <b>black bold</b> digits) show data for a specified "birthday year".</li>
                  <li>Solid <b style="color: gray;">gray bold</b> line (and <b style="color: gray;">gray bold</b> digits) show the latest available data for a specified country and sex pair. It is displayed (1) to let you to compare the trends of your birthday year with the latest data-available year, and (2) to show you how the things go right now according to the latest available data since you tend to stick with it more than with charts for your "birthday year".</li>
                </ul>
            </p>
            <p>
                <b>Q:</b> What are gray dashed charts (and gray thin digits)?<br>
                <b>A:</b> These are charts built for the latest data-available year for a "target country and sex" (country you've lived in during last 10+ years or plan to relocate to). In the top left corner legend is updated as well.
            </p>
            <p>
                <b>Q:</b> What is the purpose of this calendar?<br>
                <b>A:</b> The purpose of this calendar is to help me (and other people) (1) to visualise their life in terms of volumes and spaces rather than in abstract numbers, (2) to provide latest available scientific information about fair life expectancies for different countries, years and sexes, (3) to be informed on life expectancy change if you decide to relocate, (4) to get to know the causes and chances of deaths at different ages for me and my family - so I could be proactive and reduce the risks.
            </p>
            <p>
                <b>Q:</b> Where does this data come from?<br>
                <b>A:</b> <a href="https://mortality.org" target="_blank">mortality.org</a>
            </p>
            <p>
                <b>Q:</b> Who builds this calendar?<br>
                <b>A:</b> <a href="https://www.linkedin.com/in/aleksei-sotskov" target="_blank">Aleksei Sotskov</a>
            </p>
            <p>
                <b>Q:</b> How can I help / contribute / ask a question?<br>
                <b>A:</b> Please contact me via <a href="mailto:alexeyhimself@gmail.com?subject=[Contact you from calendarium.me] ...">alexeyhimself@gmail.com</a>
            </p>
            <p>
                <b>Q:</b> I'd like to get it in a PDF format to print and to put it on a wall. How can I do that?<br>
                <b>A:</b> You can get a PDF version of your calendar (like <a href="https://www.dropbox.com/scl/fi/uhscshx0uz04ey9dcchrh/Calendarium-1990-06-30-fi-se-m-m.pdf?rlkey=qrindotcis85o1f9v25bijo3s&dl=1" target="_blank">this one with QR-code</a> made for a Finland man moved to Sweden). Please configure the calendar you wish to print, copy URL link and send it to me at <a href="mailto:alexeyhimself@gmail.com?subject=[Order for PDF from calendarium.me] ...">alexeyhimself@gmail.com</a>. And I'll reply to you with a generated PDF.
            </p>
            <p>
                <b>Q:</b> What QR-code on a printed version does?<br>
                <b>A:</b> It leads you to online version of the Calendarium which allows you to see latest generated calendar for you, different data-skins, recommendations for health care.</a>
            </p>
          </div>
        </div>
      </div-->          
    </div>

    <p id="log"></p>
  </body>
</html>
